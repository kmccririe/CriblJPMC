exports.name="Persistent Queue Usage";exports.type="metric";exports.category="destinations";let name;let __workerGroup;let timeWindow;let usageThreshold;let usageThresholdDecimal;exports.init=e=>{const s=e.conf||{};({name,__workerGroup,timeWindow,usageThreshold}=s);timeWindow=timeWindow||"60s";usageThreshold=usageThreshold!=null?usageThreshold:90;usageThresholdDecimal=usageThreshold/100};exports.build=()=>{let e="";let s=`_metric === 'system.pq_used' && output === '${name}'`;if(__workerGroup){s=`${s} && __worker_group === '${__workerGroup}'`;e=` in group ${__workerGroup}`}return{filter:s,pipeline:{conf:{functions:[{id:"aggregation",conf:{timeWindow,aggregations:["last(_value).as(queue_usage)"],lagTolerance:"20s",idleTimeLimit:"20s"}},{id:"drop",filter:`typeof queue_usage === 'undefined' || queue_usage <= ${usageThresholdDecimal}`,conf:{}},{id:"eval",filter:`queue_usage > ${usageThresholdDecimal}`,conf:{add:[{name:"output",value:`'${name}'`},{name:"_metric",value:"'system.pq_used'"},{name:"_raw",value:`'Persistent Queue usage has surpassed ${usageThreshold}%${e}'`}]}}]}}}};